<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title></title>
  <link href="/templates/css/core.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.7.0.slim.min.js"
    integrity="sha256-tG5mcZUtJsZvyKAxYLVXrmjKBVLd6VpVccqz/r4ypFE=" crossorigin="anonymous"></script>
  <script src="/templates/js/tummo.js" type="text/javascript"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Heebo&family=Nunito&family=Open+Sans&family=Roboto+Condensed:wght@300;400&display=swap"
    rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link href="https://cdn.bootcdn.net/ajax/libs/normalize/8.0.1/normalize.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@wangeditor/editor@latest/dist/css/style.css" rel="stylesheet">
  <script src="https://unpkg.com/@wangeditor/editor@latest/dist/index.js"></script>
  <script src="/templates/js/tummoCombobox.js"></script>
  <script src="/templates/js/tummoCboCalendar.js"></script>
  <script src="/templates/js/tummoTextbox.js"></script>
  <script src="/templates/js/tummoWindow.js"></script>
  <script src="/templates/js/tummoButton.js"></script>
  <script src="/templates/js/tummoButtonUpload.js"></script>
  <script src="/templates/js/tummoAlarmQuick.js"></script>
  <script src="/templates/js/windows.js" type="text/javascript"></script>
  <script src="/b4j_ws.js"></script>
  <link href="/templates/css/core.css" rel="stylesheet">
  <link href="/templates/css/tummoCombobox.css" rel="stylesheet">
  <link href="/templates/css/tummoTextbox.css" rel="stylesheet">
  <link href="/templates/css/tummo-icon.css" rel="stylesheet">
  <link href="/templates/css/tummoButton.css" rel="stylesheet">
  <link href="/templates/css/tummoWindow.css" rel="stylesheet">
  <link href="/templates/css/tummoButton.css" rel="stylesheet">
  <link href="/templates/css/tummoCboCalendar.css" rel="stylesheet">
  <link href="/templates/css/tummoAlarmDialog.css" rel="stylesheet">
  <link rel="stylesheet" href="/templates/css/tummoWindow.css">
  <link rel="stylesheet" href="/templates/css/window.css">
  <link rel="stylesheet" href="/templates/css/material-grid-legacy.min.css">
  <script type="module" src="https://rawgit.com/leizongmin/js-xss/master/dist/xss.js"></script>
</head>

<body>
  <style>
    * {
      --width-btn: 120px;
    }

    .t-textbox-label {
      color: #2b2b2b;
    }

    label {
      color: #2b2b2b;
    }
  </style>
  <section>
    <div id="layout" class="grid">
      <div class="unit half" style="display: grid;grid-template-columns: 70px 1fr;gap:5px;">
        <ul id="gr1"
          style="line-height: 25px;height: 25px;display: flex;flex-direction: column;align-content: center;gap:5px;list-style: none;">
          <li>Tiêu đề</li>
          <li>Miêu tả</li>
          <li>Khai mạc</li>
          <li>Giáo thọ</li>
        </ul>
        <ul id="gr2" style="display: grid;grid-template-columns: 1fr;gap:5px;list-style: none;">
          <li>
            <div id="txttitle"></div>
          </li>
          <li>
            <div id="txtdes"></div>
          </li>
          <div style="display: flex;gap:5px;height: 25px;">
            <li>
              <div id="txtgio"></div>
            </li>
            <li>
              <div id="cbotungay"></div>
            </li>
            <li style="line-height:25px;margin-left: 5px;width: 60px;">Bế mạc</li>
            <li style="margin-left: 0px;">
              <div id="txtdengio"></div>
            </li>
            <li>
              <div id="cbodenngay"></div>
            </li>
          </div>
          <div style="display: flex;gap:5px;height: 25px;">
            <li>
              <div id="cbogiaotho"></div>
            </li>
            <li>
              <div id="txtsoluong"></div>
            </li>
          </div>
        </ul>
      </div>
      <div class="unit half" style="display: grid;grid-template-columns: 70px 1fr;gap:5px;">
        <ul id="gr3"
          style="line-height: 25px;height: 25px;display: flex;flex-direction: column;align-content: center;gap:5px;list-style: none;">
          <li>URL</li>
          <li>Chuyên mục</li>
          <li>Tác giả</li>
        </ul>
        <ul id="gr4" style="display: grid;grid-template-columns: 1fr;gap:5px;height: 90px;">
          <div id="txturl"></div>
          <div style="display: flex;gap:5px;height: 25px;">
            <div id="cbokieutrang"></div>
            <div id="cbochitiet"></div>
          </div>
          <div style="display: flex;gap:5px;height: 25px;">
            <div id="cbotacgia"></div>
            <div id="cbokeyword"></div>
          </div>
        </ul>
      </div>
    </div>
    <div class="grid">
      <div class="unit whole">
        <div class="tummo-editor-wrapper">
          <div id="self-toolbar" class="tummo-editor-ctrl">
            <ul class="self-toolbar">
              <div id="btntkb"></div>
              <div id="btnthumbnail"></div>
              <div id="btnmedia"></div>
              <div id="btnupload"></div>
              <div id="btnnewpost"></div>
              <div id="btndangbai"></div>
              <div id="rsthumbnail"></div>
            </ul>
          </div>
          <div id="editor-toolbar" class="tummo-editor-ctrl" style="height: 40px;">

          </div>
          <div class="tummo-editor-body">
            <div id="editor-text-area">

            </div>
            <textarea id="hidencontent" style="display: none" name="content">

          </textarea>
          </div>

        </div>
      </div>
    </div>
  </section>
  <div id="dialog" class="dialog" style="min-width:810px; min-height:630px;display: none;">
    <div class="titlebar t-window-header"><span class="t-window-title">Quản lý hình ảnh </span>
      <div class="t-window-close-bg" id="dialog_close" name="close"><span id="btnmediaclose"
          class="t-window-close"></span></div>

      <!-- enter symbol here like &times; or &#x1f6c8; or use the default X if empty -->
    </div>
    <div class="t-window-body">
      <div class="content">
        <iframe id="frameurl" style="border: none;outline:none;" src="/uploadimage.html" width="100%"
          height="100%"></iframe>
      </div>
      <div class="buttonpane">
        <div class="buttonset">
          <button class="tummo-btn btn-yellow" name="ok">Chèn ảnh</button>
          <button class="tummo-btn btn-yellow" name="cancel">Thoát</button>
        </div>
      </div>
    </div>
    <div class="t-window-footer"></div>
  </div>

  <!-- THOI KHOA BIEU -->
  <div id="dialogtkb" class="dialog" style="min-width:820px; min-height:630px;display: none;overflow: hidden;">
    <div class="titlebar t-window-header"><span id="dialogtkb_title" class="t-window-title">Biên soạn thời khoá
        biểu</span>
      <div id="dialogtkb_close" class="t-window-close-bg" name="close"><span class="t-window-close"></span></div>
    </div>
    <div class="t-window-body">
      <div class="content">
        <iframe id="frametkb" style="border: none;outline:none;" src="" width="100%" height="100%"></iframe>
      </div>
      <div class="buttonpane">
        <div class="buttonset">
          <button class="tummo-btn btn-yellow" name="cancel">Thoát</button>
        </div>
      </div>
    </div>
    <div class="t-window-footer"></div>
  </div>
  <div id="alarm"></div>
  <div id="meadia"></div>
  <script th:inline="javascript">
    /*<![CDATA[*/
    var article = /*[[${article}]]*/ 'title';
    var tentacgia = /*[[${tentacgia}]]*/ 'tentacgia';
    var tenchuyenmuc = /*[[${tenchuyenmuc}]]*/ 'tenchuyenmuc';
    var tentrang = /*[[${tentrang}]]*/ 'tentrang';
    var loaitrang = /*[[${loaitrang}]]*/ 'loaitrang';
    var editable = /*[[${editable}]]*/ '';
    var _id = /*[[${idbaiviet}]]*/ '';
    /*]]>*/
    var dialog;
    var dialogtkb;
    dialog = new DialogBox('dialog', callbackDialog);
    dialogtkb = new DialogBox('dialogtkb', callbackDialog);

    let today = new Date();
    let _emptydate = convertDate2(today);

    if(article.tungay != null, article.tungay = _emptydate);
      if(article.denngay != null, article.denngay = _emptydate);

    var dialogalarm = $('#alarm').tummoAlarmQuick({ text: 'Dữ liệu đã được cập nhật hoàn thành!' });
    var _w = (document.getElementById("layout").offsetWidth / 2) - 100;

    var txttitle = $('#txttitle').tummoTextbox({ placeholder: 'Tiêu đề bài viết', type: 'text', width: _w, onLostFocus: f_title_lostfocus, labelWidth: 0 });
    var txturl = $('#txturl').tummoTextbox({ placeholder: 'Đường dẫn bài viết (Được tạo tự động)', type: 'text', width: _w, labelWidth: 0, onLostFocus: null });
    var txtDes = $('#txtdes').tummoTextbox({ placeholder: 'Miêu tả ngắn (Tốt cho SEO)', type: 'text', labelWidth: 0, fullWidth: true, width: _w });

    var _w2 = (_w / 2) - 55;

    var cbokieutrang = $('#cbokieutrang').tummoCombobox({ width: _w2 + 25, url: '/api/v3/?id=category', labelWidth: 0, onChange: cateCategory, default: { value: loaitrang, text: tentrang } });
    var cbochitiet = $('#cbochitiet').tummoCombobox({ width: _w2 + 25, url: '/api/v3/?id=categorychild&filter=101', label: 'Chi tiết', labelWidth: 55, onChange: cateEvent, default: { value: article.category, text: tenchuyenmuc } });
    var cbotacgia = $('#cbotacgia').tummoCombobox({ width: _w2 + 25, url: '/api/v3/?id=author', labelWidth: 0, default: { value: article.author, text: tentacgia } });
    var cbokeyword = $('#cbokeyword').tummoCombobox({ width: _w2 + 25, url: '/api/v3/?id=keyword&filter=KEY-001', labelWidth: 55, label: 'Từ khoá', checkbox: true, default: { value: article.keyword, text: article.keyword } });
    var cbogiaotho = $('#cbogiaotho').tummoCombobox({ width: _w2 + 25, url: '/api/v3/?id=giaotho', labelWidth: 0, hasIcon: true });
    let _now = new Date();

    let _w3 = (_w2 - 50);

    var txtgio = $('#txtgio').tummoTextbox({ placeholder: _now.getHours() + ':' + _now.getMinutes() + ':00', type: 'text', labelWidth: 0, fullWidth: false, width: 70 });

    let _tungay = convertDate2(article.tungay);
    let _denngay = convertDate2(article.denngay);

    var cbotungay = $('#cbotungay').tummoCboCalendar({ width: _w3, style: 'yellow', labelWidth: 0, label: '', multipleSelect: false, default: { value: _tungay, text: _tungay } });
    var txtdengio = $('#txtdengio').tummoTextbox({ placeholder: _now.getHours() + ':' + _now.getMinutes() + ':00', type: 'text', labelWidth: 0, lablel: 'Bế mạc', fullWidth: false, width: 70 });
    var cbodenngay = $('#cbodenngay').tummoCboCalendar({ width: _w3 - 15, style: 'yellow', labelWidth: 0, label: '', multipleSelect: false, default: { value: _denngay, text: _denngay } });

    var btntkb = $('#btntkb').tummoButton({ text: 'T.K.Biểu', icon: '<img src="/icons/thoikhoabieu.svg">', style: 'yellow', click: f_opentkb });
    var btnpublish = $('#btndangbai').tummoButton({ text: 'Đăng bài', icon: '<img src="/icons/publish.svg">', style: 'yellow', click: f_publish });
    var btnmedia = $('#btnmedia').tummoButton({ text: 'Kho hình ảnh', icon: '<img src="/icons/insertimage.svg">', style: 'yellow', click: f_openmedia });
    var btnupload = $('#btnupload').tummoButtonUpload({ text: 'Upload', icon: '<img src="/icons/upload.svg">', server: '/upload/v2/id=images', style: 'yellow', click: f_uploaded });
    var btnthumbnail = $('#btnthumbnail').tummoButtonUpload({ text: 'Hình đại diện', icon: '<img src="/icons/upload.svg">', server: '/upload/v2/id=images', uploadcompleted: thumbnail_uploaded, style: 'yellow', click: f_thumbnail });
    var btnnewpost = $('#btnnewpost').tummoButton({ text: 'Thêm bài mới', icon: '<img src="/icons/newpage.svg">', style: 'yellow', click: f_newpost });

    var txtsoluong = $('#txtsoluong').tummoTextbox({ placeholder: 'Giới hạn số Phật tử tham gia sự kiện', type: 'text', labelWidth: 60, label: 'Số lượng', fullWidth: true, width: _w2 + 10 });

    var htmltag = [{ id: 0, value: '<h1>', text: 'vd', default: false, checked: false }];

    var _wcbo = (_w / 2) - 27;

    function callbackDialog(btnName) {
      _showDialogButton.disabled = false;
      _showDialogButton.focus();
      if (btnName == 'close')
        _statusDialog.textContent = 'Dialog hidden...';
      else
        _statusDialog.textContent = btnName + ' button clicked...';
    }

    function f_thumbnail() {
      // $('#rsthumbnail').textContent = getContent();     

    }

    function cateEvent(value) {
      let _eventid = cbochitiet.getValue();
      b4j_raiseEvent('event_changed', { id: _id, url: txturl.getValue(), giaotho: cbogiaotho.getValue() });
    }

    function f_newpost() {
      txttitle.setValue('');
      txturl.setValue('');
      txtDes.setValue('');
      editor.setHtml('');
    }

    function thumbnail_uploaded(json) {

      let fullpath = json[0].path + '/' + json[0].filename;
      fullpath = fullpath.replace('/', '\\');
      document.getElementById('rsthumbnail').textContent = fullpath;

    }

    function pad(s) { return (s < 10) ? '0' + s : s; }

    function convertDate(date, hour) {
      if (hour.length <= 5) {
        hour = hour + ":20";
      }

      date = new Date(date + ' ' + hour);
      var year = date.getFullYear();
      var month = date.getMonth() + 1;
      var day = date.getDate();

      let _d = [year, pad(month), pad(day)].join('-');

      return _d + ' ' + hour;
    }

    function getContent() {
      let _thumb = document.getElementById('rsthumbnail').textContent;
      let _body = editor.getHtml();
      let _tn = new String(cbotungay.getValue());
      let _tungay = '';
      let _denngay = '';
      let _des = txtDes.getValue();
      _des = _des.replace("'", "\'");
      _body = _body.replace(/["']/g, "");
      var html = filterXSS(_body);

      _tungay = convertDate(cbotungay.getValue(), txtgio.getValue());
      _denngay = convertDate(cbodenngay.getValue(), txtdengio.getValue());

      let content = [{
        id: _id,
        title: txttitle.getValue(),
        url: txturl.getValue(),
        des: _des,
        thumbnail: _thumb,
        body: html,
        soluong: txtsoluong.getValue(),
        tacgia: cbotacgia.getValue(),
        keyword: cbokeyword.getText(),
        tungay: _tungay,
        giaotho: cbogiaotho.getValue(),
        denngay: _denngay,
        category: cbokieutrang.getValue(),
        masukien: cbochitiet.getValue(),
      }];

      return content;
    }

    function f_publish() {
      let content = JSON.stringify(getContent());
      b4j_raiseEvent('article_changed', { data: content });
      dialogalarm.show('Dữ liệu đã được cập nhật hoàn thành!');

    }
    function f_opentkb() {
      document.getElementById('dialogtkb_title').innerHTML = 'T.K.Biểu: ' + txttitle.getValue();
      document.getElementById('frametkb').setAttribute('src', '/templates/_source_tkb.htm?filter=' + _id);
      dialogtkb.showDialog();
    }

    function cateCategory(id) {
      let url = '/api/v3/?id=categorychild&filter=' + id;
      cbochitiet.reload(url, null);
    }
    function f_title_lostfocus(id) {
      if (editable == false) {
        let text = txttitle.getValue();
        b4j_raiseEvent('txttieude_changed', { title: text, id: _id });
      }

    }

    // ----------------------- EDITOR
    // ----------------------- EDITOR
    var editorbody = '';
    const E = window.wangEditor;
    const LANG = location.href.indexOf('lang=en') > 0 ? 'en' : 'en';
    E.i18nChangeLanguage(LANG);
    const $text1 = $('#hidencontent');
    window.editor = E.createEditor({
      selector: '#editor-text-area',
      html: '<p><br></p><p><br></p>',
      config: {
        placeholder: 'Type here...',
        height: 500,
        MENU_CONF: {
          uploadImage: {
            server: 'wss://51.79.254.135:7676/upload/v2/id=images',
            base64LimitSize: 10 * 1024 * 1024 // 10M 以下插入 base64
          }
        }
      }
    }
    )

    window.toolbar = E.createToolbar({
      editor,
      selector: '#editor-toolbar',
      config: {}
    });

    window.addEventListener("message", function (_data) {
      let result = _data.data[0];
      inserImageToEditor(result);

    });
    function inserTextToEditor(html) {
      if (editor.isDisabled()) editor.enable();
      if (!editor.isFocused()) editor.focus();

      editor.select([]);

      E.SlateTransforms.setNodes(editor, { type: 'paragraph' }, { mode: 'highest' });
      editor.setHtml(html);
    }


    function inserImageToEditor(image) {
      if (editor.isDisabled()) editor.enable();
      if (!editor.isFocused()) editor.focus();

      E.SlateTransforms.setNodes(editor, { type: 'paragraph' }, { mode: 'highest' });
      editor.dangerouslyInsertHtml('<img src="' + image + '"/>');
    }

    function f_openmedia() {
      dialog.showDialog();
    }

    function f_uploaded(event) {
      if (event == true) {
        dialogalarm.show('Tệp đã được tải thành công lên máy chủ!');
      }

    }

    $(document).ready(function () {
      b4j_connect('/ws/edit');

      var _showDialogButton = document.getElementById('show-dialog');
      var _statusDialog = document.getElementById('dialog-status');
      txttitle.setValue(article.title);
      txturl.setValue(article.link);
      txtDes.setValue(article.des);

      let _hour_tn = converHours(article.tungay);
      let _hour_dn = converHours(article.denngay);

      if(_hour_tn != null, _hour_tn = '');
      if(_hour_dn != null, _hour_dn = '');

      txtgio.setValue(_hour_tn);
      txtdengio.setValue(_hour_dn);
      txtsoluong.setValue(article.soluong);

      let nstr = new String(article.category);
      let arr = nstr.split('-');
      cbochitiet.reload('/api/v3/?id=categorychild&filter=' + arr[0], null);

      document.getElementById('rsthumbnail').textContent = article.thumbnail;
      inserTextToEditor(article.content);


      //cbotungay.
    });

  </script>



</body>

</html>